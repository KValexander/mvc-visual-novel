<script>
	genres = []; screenshots = []; platforms = [];
	// Calling functions
	load_left();
	load_right();
	load_data();

	// Loading layout
	function load_left() {
		out = `
			<h2>Добавление новеллы</h2>
			<div class="add_novel">
				<!-- Adding a novel -->
				<form onsubmit="return add_novel()">
					<!-- Novel titles -->
					<fieldset>
						<legend>Названия</legend>
						<p class="error" id="title"></p>
						<input type="text" placeholder="Название" name="title">
						<input type="text" placeholder="Оригинальное название" name="original_title">
						<input type="text" placeholder="Альтернативное название" name="alternative_title">
					</fieldset>
					<!-- Novel images -->
					<fieldset>
						<legend>Изображения</legend>
						<p>Обложка новеллы</p>
						<p class="notice">Изображение должно весить не более 1мб</p>
						<p class="error" id="cover"></p>
						<input type="file" name="cover">
						<p>Скриншот новеллы</p>
						<p class="error" id="screenshot"></p>
						<p class="notice">Изображения должны весить не более 1мб</p>
						<div class="part">
							<input type="file" id="screenshot">
							<input type="button" value="Добавить" onclick="add_screenshot()">
						</div>
						<div class="screenshots"></div>
					</fieldset>
					<!-- Developer, release year and description -->
					<fieldset>
						<legend>Разработчик, год релиза и описание</legend>
						<p class="error" id="developer"></p>
						<input type="text" placeholder="Разработчик" name="developer">
						<p class="error" id="year_release"></p>
						<input type="number" placeholder="Год релиза" name="year_release">
						<p class="error" id="description"></p>
						<textarea placeholder="Описание" name="description"></textarea>
					</fieldset>
					<!-- Genres -->
					<fieldset>
						<legend>Жанры</legend>
						<p class="error" id="genres"></p>
						<div class="part">
							<select name="genres"></select>
							<input type="button" value="Добавить" onclick="add_genre()">
						</div>
						<div class="genres"></div>
					</fieldset>
					<!-- Lists -->
					<fieldset>
						<legend>Списки</legend>
						<p class="error" id="type"></p>
						<select name="type">
							<option selected disabled>Тип</option>
							<option value="Новелла с выборами">Новелла с выборами</option>
							<option value="Кинетическая новелла">Кинетическая новелла</option>
						</select>
						<p class="error" id="duration"></p>
						<select name="duration">
							<option selected disabled>Продолжительность</option>
							<option value="Менее 2 часов">Менее 2 часов</option>
							<option value="2-10 часов">2-10 часов</option>
							<option value="10-30 часов">10-30 часов</option>
							<option value="30-50 часов">30-50 часов</option>
							<option value="Более 50 часов">Более 50 часов</option>
						</select>
						<p class="error" id="platforms"></p>
						<div class="part">
							<select name="platforms">
								<option selected disabled>Платформа</option>
								<option value="Windows">Windows</option>
								<option value="Linux">Linux</option>
								<option value="Mac">Mac</option>
								<option value="Android">Android</option>
								<option value="iOS">iOS</option>
								<option value="Другое">Другое</option>
							</select>
							<input type="button" value="Добавить" onclick="add_platform()"></input>
						</div>
						<div class="platforms"></div>
						<p class="error" id="age_rating"></p>
						<select name="age_rating">
							<option selected disabled>Возрастной рейтинг</option>
							<option value="G">G</option>
							<option value="PG">PG</option>
							<option value="PG-13">PG-13</option>
							<option value="R">R</option>
							<option value="NC-17">NC-17</option>
						</select>
						<p class="error" id="country"></p>
						<select name="country">
							<option selected disabled>Страна</option>
							<option value="Россия">Россия</option>
							<option value="Япония">Япония</option>
							<option value="США">США</option>
						</select>
						<p class="error" id="language"></p>
						<select name="language">
							<option selected disabled>Язык</option>
							<option value="Русский">Русский</option>
							<option value="Японский">Японский</option>
							<option value="Английский">Английский</option>
						</select>
					</fieldset>
					<input type="submit" value="Отправить на модерацию">
				</form>
			</div>
		`;
		$(".left .wrap .tab_content").html(out);
	}
	// Loading layout
	function load_right() {
		out = `<div id="preview"></div>`;
		$(".right .wrap .tab_content").html(out);
	}

	// Loading data
	function load_data() {
		request.get(data => {
			data = JSON.parse(data);
			out = `<option selected disabled>Жанры</option>`;
			if (data.data.genres.length != 0)
				data.data.genres.forEach(genre => out += `<option value="${genre.genre_id}">${genre.genre}</option>`);
			$("select[name=genres]").html(out);
		}, null, "api/directory/get");
	}

	// Adding genres to an array
	function add_genre() {
		let id = $("select[name=genres]").val();
		let text = $("select[name=genres]").find("option:selected").text();
		if (id == null) return;

		let check = genres.find(genre => genre == id);
		if (check != undefined) return;

		genres.push(id);
		out = `<div class="genre" onclick="remove_genre(event)">${text}</div>`;

		$(".genres").append(out);
	}
	
	// Remove genre
	function remove_genre(e) {
		let dId = $(`select[name=genres] option:contains("${e.target.innerHTML}")`).val();
		let cIc = genres.findIndex(id => id == dId);
		genres.splice(cIc, 1);
		e.target.remove();
	}

	// Add screenshot to array
	function add_screenshot() {
		let screenshot = $("input#screenshot").prop("files")[0];
		if (screenshot == undefined) return;
		$("input#screenshot").val("");
		screenshots.push(screenshot);
		out = `<div class="screenshot" onclick="remove_screenshot(event)">${screenshot.name}</div>`;
		$(".screenshots").append(out);
	}

	// Remove screenshot
	function remove_screenshot(e) {
		let cIc = screenshots.findIndex(screenshot => screenshot.name == e.target.innerHTML);
		screenshots.splice(cIc, 1);
		e.target.remove();
	}

	// Add platform to array
	function add_platform() {
		let id = $("select[name=platforms]").val();
		let text = $("select[name=platforms]").find("option:selected").text();
		if (id == null) return;

		let check = platforms.find(platform => platform == id);
		if (check != undefined) return;

		platforms.push(id);
		out = `<div class="platform" onclick="remove_platform(event)">${text}</div>`;

		$(".platforms").append(out);
	}
	
	// Remove platform
	function remove_platform(e) {
		let dId = $(`select[name=platforms] option:contains("${e.target.innerHTML}")`).val();
		let cIc = platforms.findIndex(id => id == dId);
		platforms.splice(cIc, 1);
		e.target.remove();
	}

	// Add novel
	function add_novel() {
		let formData = new FormData($("form")[0]);
		formData.append("genres", genres);
		formData.append("platforms", platforms);
		screenshots.forEach((screenshot, i) => formData.append("screenshot"+i, screenshot));
		request.post(data => {
			data = JSON.parse(data);
			$("input").removeClass("err"); $("select").removeClass("err"); $("textarea").removeClass("err");
			$("p.error").html("").removeClass("error_acc");
			// In case of success
			if (data.status == 200 || data.status == 204) {
				// Displaying a success message
				message.show(data.data);
				// Clearing form data
				$("form")[0].reset();
				genres = []; screenshots = []; platforms = [];
				$(".genres").html("");
				$(".screenshots").html("");
				$(".platforms").html("");
			// In case of error
			} else if (data.status == 400){
				message.show(data.data);
			// In case of error
			} else if(data.status == 422) {
				for(key in data.data.errors) {
					let error = data.data.errors[key];
					$("#"+key).html(error).addClass("error_acc");
					$(`[name=${key}]`).addClass("err");
				}
			}
		}, formData, "api/add/novel", true);
		return false;
	}
</script>